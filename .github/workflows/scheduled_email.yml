name: Run Scheduled Colab Notebook

on:
  schedule:
    - cron: "0 3 * * *"  # 05:00 local time (adjust if needed)
  workflow_dispatch:

jobs:
  run-notebook:
    runs-on: ubuntu-latest

    env:
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install nbconvert nbformat ipykernel jupyter openpyxl yagmail

    - name: Run notebook
      run: |
        jupyter nbconvert --to notebook --execute source_kod.ipynb \
          --output executed_notebook.ipynb \
          --ExecutePreprocessor.timeout=600 \
          --ExecutePreprocessor.allow_errors=True

    - name: Send email with Excel attachments
      run: |
        python -c "
import os, yagmail

sender = os.environ['EMAIL_USER']
password = os.environ['EMAIL_PASSWORD']
recipient = os.environ['EMAIL_TO']

# List Excel files from output folder
output_folder = './output_folder'
excel_files = [os.path.join(output_folder, f) for f in os.listdir(output_folder) if f.endswith('.xlsx')]

if not excel_files:
    print('‚ùå No Excel files found to attach.')
else:
    yag = yagmail.SMTP(user=sender, password=password)
    yag.send(to=recipient, subject='üìä Daily Excel Reports', contents='Attached are today\'s Excel files.', attachments=excel_files)
    print(f'‚úÖ Email sent to {recipient} with {len(excel_files)} Excel file(s).')
        "

    - name: Clean up Excel output folder
      run: |
        rm -f ./output_folder/*.xlsx

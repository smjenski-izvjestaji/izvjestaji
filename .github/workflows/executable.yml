name: NO TIMEZONE Run and Email Excel Files

on:
  schedule:
    # Covers CET and CEST offsets, we‚Äôll filter in job
    - cron: '*/5 */1 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  EMAIL_USER: ${{ secrets.EMAIL_USER }}
  EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
  EMAIL_TO: ${{ secrets.EMAIL_TO }}
  API_KEY: ${{ secrets.API_KEY }}
  SECRET_KEY: ${{ secrets.SECRET_KEY }}

jobs:
  run-notebook-and-email:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üì¶ Install dependencies
        run: |
          pip install nbconvert nbformat ipykernel jupyter openpyxl requests

      - name: üìò Execute notebook
        run: |
          jupyter nbconvert \
            --to notebook \
            --execute evocon_kod_executable.ipynb \
            --output executed_notebook.ipynb \
            --ExecutePreprocessor.timeout=600

      - name: üì§ Upload executed notebook
        uses: actions/upload-artifact@v4
        with:
          name: executed-notebook
          path: executed_notebook.ipynb

      - name: üìß Send Email with Excel Attachments
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Evocon Smjenski izvje≈°taji"
          body: "U privitku se nalaze dana≈°nji smjenski izvje≈°taji za odreƒëenu smjenu."
          from: ${{ secrets.EMAIL_USER }}
          to: ${{ secrets.EMAIL_TO }}
          attachments: |
            excel_reports/*.xlsx

      - name: üßπ Clean Excel Output Folder
        run: |
          rm -f excel_reports/*.xlsx
